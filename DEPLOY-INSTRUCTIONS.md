# Инструкция по деплою ETM Backend + исправленный фронтенд

## Что в архиве

### Новые файлы (создать/загрузить на сервер):
```
/new/
├── .htaccess                    ← НОВЫЙ (MIME-типы для JS)
├── api/                         ← НОВАЯ ПАПКА (весь backend)
│   ├── .htaccess                  URL rewriting
│   ├── index.php                  Роутер
│   ├── config.php                 ⚠️ НАСТРОИТЬ перед деплоем!
│   ├── db.php                     Подключение к БД
│   ├── helpers.php                Общие функции
│   ├── auth.php                   Аутентификация
│   ├── projects.php               CRUD проектов
│   ├── partners.php               CRUD партнёров
│   ├── certificates.php           CRUD сертификатов
│   ├── upload.php                 Загрузка изображений
│   ├── setup.php                  ⚠️ УДАЛИТЬ после настройки!
│   └── database.sql               SQL-скрипт для БД
├── uploads/                     ← НОВАЯ ПАПКА (создать, chmod 755)
```

### Обновлённые файлы (заменить на сервере):
```
├── login.html                   ← ЗАМЕНИТЬ (добавлено поле логин)
├── admin-panel.html             ← ЗАМЕНИТЬ (относительные пути, upload)
├── src/js/config/api.js         ← ЗАМЕНИТЬ (локальный backend)
├── src/js/config/constants.js   ← ЗАМЕНИТЬ (новые эндпоинты)
├── src/js/utils/auth.js         ← ЗАМЕНИТЬ (серверная auth)
├── src/js/pages/admin.js        ← ЗАМЕНИТЬ (file upload, серверная auth)
├── src/js/pages/login.js        ← ЗАМЕНИТЬ (логин + пароль)
```

---

## Пошаговый план

### Шаг 1: Создать базу данных MySQL

В панели хостинга:
1. Создать базу данных (например `etm_site`)
2. Создать пользователя MySQL
3. Дать пользователю ВСЕ привилегии на эту базу
4. Запомнить: имя базы, пользователь, пароль

### Шаг 2: Выполнить SQL-скрипт

В phpMyAdmin (или аналог):
1. Выбрать созданную базу
2. Вкладка «SQL» или «Импорт»
3. Вставить/загрузить содержимое `api/database.sql`
4. Выполнить

### Шаг 3: Настроить config.php

Открыть `api/config.php` и заполнить:
```php
define('DB_HOST', 'localhost');
define('DB_NAME', 'ваша_база');      // Имя базы из шага 1
define('DB_USER', 'ваш_юзер');       // Пользователь из шага 1
define('DB_PASS', 'ваш_пароль');     // Пароль из шага 1
```

### Шаг 4: Загрузить файлы на сервер по FTP

1. Загрузить папку `api/` в `/new/api/`
2. Загрузить `.htaccess` в `/new/.htaccess`
3. Создать папку `/new/uploads/` (chmod 755)
4. Заменить обновлённые файлы:
   - `login.html`
   - `admin-panel.html`
   - `src/js/config/api.js`
   - `src/js/config/constants.js`
   - `src/js/utils/auth.js`
   - `src/js/pages/admin.js`
   - `src/js/pages/login.js`

### Шаг 5: Установить пароль админа

1. Открыть в браузере: `https://etm-murmansk.ru/new/api/setup.php`
2. Проверить что все таблицы ✅
3. Ввести логин (admin) и пароль
4. Нажать «Сохранить пароль»
5. **УДАЛИТЬ файл setup.php с сервера!**

### Шаг 6: Проверка

1. Открыть `https://etm-murmansk.ru/new/api/projects` — должен вернуть JSON:
   ```json
   {"data":[],"total":0,"limit":100,"offset":0}
   ```
2. Открыть `https://etm-murmansk.ru/new/login.html` — ввести логин/пароль
3. Должен перенаправить на admin-panel.html
4. Проверить: Quill-редактор виден, табы переключаются

---

## Что изменилось по сравнению со старой версией

| Было | Стало |
|------|-------|
| Внешний API (Genspark) | Свой PHP + MySQL |
| Пароль в JS-коде | Серверная проверка (bcrypt) |
| Абсолютные пути `/src/...` | Относительные `src/...` |
| Только URL изображений | URL + загрузка файлов |
| Клиентские сессии | Серверные токены |

## Решение возможных проблем

### API возвращает 404
→ Проверить что `api/.htaccess` загружен и `mod_rewrite` включён

### API возвращает 500
→ Проверить `config.php` (данные БД), проверить что таблицы созданы

### JS-модули не загружаются (MIME type error)
→ Проверить что `.htaccess` в корне `/new/` загружен

### Загрузка файлов не работает
→ Проверить что папка `uploads/` существует и имеет права 755
